<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>PhantomJSを使ってみたい気がした[001] | 6億円</title>
  <meta name="description" content="What a rock de nothing we are!!" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="6億円">

  
  
  

  
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="//www.gravatar.com/avatar/948162baf94b40a4c6137837333d6c2ccasper" alt="Blog Logo"/></a> 
            <h1 class="blog-title">6億円</h1>
            <h2 class="blog-description">What a rock de nothing we are!!</h2>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2015-10-20T09:02:54.000Z" itemprop="datePublished">
          2015-10-20
      </time>
    
    
    | 
    <a href='/tags/chai/'>chai</a>,
    
    <a href='/tags/install/'>install</a>,
    
    <a href='/tags/mocka/'>mocka</a>,
    
    <a href='/tags/phantomjs/'>phantomjs</a>,
    
    <a href='/tags/sinon/'>sinon</a>
    
    
</span>
    <h1 class="post-title">PhantomJSを使ってみたい気がした[001]</h1>
    <section class="post-content">
      <p>PhantomJSをやってみる。</p>
<img src="/2015/10/20/feel-that-i-want-use-phantomjs/phantomjs2.png" alt="PhantomJS" title="PhantomJS">
<p>JavaScriptのテストケースにはいろいろあって、中でもちょっとだけかじってたのが、</p>
<ul>
<li>mocka</li>
<li>chai</li>
<li>sinon</li>
</ul>
<p>を混ぜて使ってた感じ。</p>
<p>でも全然本格的に業務で使ってた訳じゃないし、もう使い方を忘れてしまった。<br>※近々リベンジする予定</p>
<h2 id="ヘッドレスでSS">ヘッドレスでSS</h2><p>ヘッドレスでいいのでコマンドラインで使えるブラウザ的な存在、PhantomJSを使ってみたくなった。</p>
<p>指定したURLにアクセスし、何かを操作した状態のSS(スクリーンショット)を撮りたい。</p>
<p>以前使ったことがあるんだけど、本当にサンプル程度しかいじってないので、もう少し突っ込んで使ってみたい。</p>
<h2 id="PhantomJSとは">PhantomJSとは</h2><p>そもそもPhantomJSってなんぞや？ってところから始めたい。</p>
<ul>
<li>QtWebKitを使用している</li>
<li>JavaScriptの実行が可能</li>
<li>DOMやCSSを扱える</li>
<li>CanvasやSVGによる描画などにも対応</li>
</ul>
<p>ということらしい。QtってのはNokiaのUIツールキットだと思う。C++とかでQt4いじったことがある人は馴染み深いと思う。そういえばQt Creatorとかってあるなぁ。</p>
<p>閑話休題。</p>
<p>要するにヘッドレスなので表示部分がない、言わばデーモンみたいなブラウザということで概ね問題無いと思う。<br>そいつをつかって、自動化してテストしてしまおうって流れ。</p>
<h2 id="インストール">インストール</h2><p>前提条件として、<a href="http://qiita.com/_daisuke/items/d3b2477d15ed2611a058" target="_blank" rel="external">homebrewがインストール</a>されてること。</p>
<p>まずはPhantomJSを検索してみる。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span>search phantomjs</span><br></pre></td></tr></table></figure>
<p>としたら出てきた。<br>バージョンは1.9.8らしい。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">homebrew<span class="regexp">/versions/</span>phantomjs198</span><br></pre></td></tr></table></figure>
<p>インストールしよう。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span>install phantomjs</span><br></pre></td></tr></table></figure>
<p>インストール後の確認。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ phantomjs --version</span><br><span class="line"><span class="number">1.9</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>
<p>問題なし。</p>
<h2 id="テストしてみる">テストしてみる</h2><p><a href="http://phantomjs.org/" target="_blank" rel="external">PhantomJSの公式</a>にはこんなソースコードが記載されている。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'Loading a web page'</span>);</span><br><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create();</span><br><span class="line"><span class="keyword">var</span> url = <span class="string">'http://phantomjs.org/'</span>;</span><br><span class="line">page.open(url, <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//Page is loaded!</span></span><br><span class="line">  phantom.exit();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>これをそのまま使ってみようじゃねーかコラ。</p>
<p><code>example.js</code>として保存し、以下のコマンドでPhantomJSを実行する。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>phantomjs example.js</span><br></pre></td></tr></table></figure>
<p>しばらくするとconsole.log()が起動する。そして、終る。<br>終るのは<code>phantom.exit();</code>があるためで、これがなければコンソールはプロンプトは返さず、ループ状態のままになる。もちろん<code>Ctrl+C</code>もしくは<code>cmd+.</code>で強制終了は可能。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ phantomjs example<span class="class">.js</span></span><br><span class="line">Loading <span class="tag">a</span> web page</span><br></pre></td></tr></table></figure>
<h2 id="少しいじってみる">少しいじってみる</h2><p>せっかく仮引数に<code>status</code>が用意されてるのにブロック内で使われてないので、全力で使ってみる。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">page.open(url, <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status === <span class="string">'success'</span>) &#123;</span><br><span class="line">        <span class="comment">// 上品な方</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'no problem.'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 下品な方</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'what the fuck!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    phantom.exit();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>LANケーブルを抜いたり、ネットワークアプリを停止させてテストすると、「下品な方」を表示できる。<br>お試しあれ。</p>
<h2 id="SS撮ってみる">SS撮ってみる</h2><p>SSというのはスクリーンショットという意味で使ってるんだけど、どちらかと言うとこれは違うかな。<br>何しろヘッドレスなのでスクリーンが無い。それに、ショットというのも少々有機的な感じがする。<br>だから、キャプチャという単語を使おう。</p>
<p>キャプチャするには、pageのrender()メソッドにファイル名を指定するだけでOKだ。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">page.open(url, <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status === <span class="string">'success'</span>) &#123;</span><br><span class="line">        <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            page.render(<span class="string">'phantomjs.png'</span>);</span><br><span class="line">            phantom.exit();</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>NodeJSやってる人は何度も身に覚えがあると思うけど、<code>setTimeout()</code>を <strong>非同期で使ってる</strong> ので、<code>phantom.exit()</code>をスコープ外に出しちゃうと、キャプチャする前に終了してしまうので注意。<br>これは熟練者でもなければ案外カジュアルにハマるポイント。</p>
<p>うまくいくと、こんな画像が楽しめる。</p>
<img src="/2015/10/20/feel-that-i-want-use-phantomjs/phantomjs.png" alt="PhantomJS.org" title="PhantomJS.org">
<p>ちなみにpngなどのアルファチャンネルを持った画像にする場合、背景色が透過されてて、ちょっとアレゲな感じがする。このページは背景が白いので問題ないが・・・。</p>
<p>次は試しに日本語のサイトをキャプチャしてみよう。</p>
<img src="/2015/10/20/feel-that-i-want-use-phantomjs/nlab.png" alt="ねとらぼ" title="ねとらぼ">
<p>問題なさそうだ。</p>
<p>ぱっと浮かんだサイトが<a href="http://gigazine.net/" target="_blank" rel="external">GIGAZINE</a>と<a href="http://nlab.itmedia.co.jp/" target="_blank" rel="external">ねとらぼ</a>だったんだけど、GIGAZINEはキャプチャとして全くおもしろみがないし、とりあえずねとらぼでいいか、的な安易な結論。</p>
<p>ねとらぼTOPを1ページまるごとキャプチャすると、今見ているこのページが果てしなくねとらぼになってしまうので、キャプチャ画像はトリミングしておいた。</p>
<h2 id="最後に">最後に</h2><p>今回は全然突っ込んだ使い方してないので、次回は実際にサイト内をクリックとかタップした際のアクションをエミュレートしてキャプチャを撮ってみたりしてみたい気がしないでもない。</p>
<p>気が向いたらやる。</p>
<p>そのうちCasperJSも使いたいかも。</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Seiji Ogawa</h4>
    <p>Frontend and backend Engineer.</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=s-ogawa-mediba.github.io/2015/10/20/feel-that-i-want-use-phantomjs/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=s-ogawa-mediba.github.io/2015/10/20/feel-that-i-want-use-phantomjs/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=s-ogawa-mediba.github.io/2015/10/20/feel-that-i-want-use-phantomjs/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2015/10/20/install_hexo_mac/">
        hexoをつかってGithubページにブログを作る →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">6億円</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>






</body>
</html>
